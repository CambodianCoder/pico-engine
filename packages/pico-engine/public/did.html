<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>DID redirection</title>
<script src="js/jquery-3.1.0.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/async.min.js"></script>
<script type="text/javascript">
$(function(){
  var this_npe = location.hostname+(location.port ? ":"+location.port : "");
  var servers = [
    this_npe,
    "10.5.36.219:8080",
    "sqtg.bruceatbyu.com:3001",
    "605ea45c.ngrok.io",
  ];
  if(location.search.startsWith("?url=")){
    var decoded = decodeURIComponent(location.search);
    if(decoded.startsWith("?url=web+did:npe:")){
      var pieces = decoded.substr(17).split("/");
      if(pieces.length >= 5){
        var eci = pieces.shift();
        var stuff = pieces.shift() + "/" + pieces.shift() + "/"
                  + eci + "/" + pieces.join("/");
        var tryURL = function(server) {
          var tryStuff = "sky/cloud/"+eci+"/io.picolabs.pico/myself";
          return "http://"+server+"/"+tryStuff;
        };
        var tryServer = function(server,callback) {
          setTimeout(function(){
            var theURL = tryURL(server);
            $.getJSON(theURL, function(data){
              callback(null,(data && data.id));
            }).fail(function(){callback(null,false)});
          },1);
        };
        async.detectSeries(servers,tryServer,function(err,server){
          if(server){
            var prefix = "http://" + server + "/";
            location = prefix+stuff;
          } else {
            $("body").html("Couldn't find <code>did:"+eci+"</code>, having checked<ul><li>"+servers.join("</li><li>")+"</li></ul>");
            $("body").show();
          }
        });
      } else {
        $("body").show();
      }
    } else {
      $("body").show();
    }
  } else {
    $("body").show();
  }
  $("#npe").text(this_npe);
  var rph = 'navigator.registerProtocolHandler("web+did","http://'
          + this_npe
          + '/did.html?url=%s","DID poc")';
  $("#rph").attr("href",'javascript:'+rph+';void 0');
  $("#rph").text(rph);
  $("#servers").html("<li>"+servers.join("</li><li>")+"</li></ul>");
});
</script>
<style type="text/css">
pre { margin-left:20px; }
body { display:none; }
</style>
</head>
<body>
<h1>DID redirection</h1>
<p>
This is a proof of concept, through simulation.
Soon, browsers will understand the <code>did</code> scheme directly.
They will use the DID to find the DDO on Sovrin and the DDO
will provide a list of endpoints for your browser to try.
Until then, we can use this simulator,
which will try a series of Node Pico Engines (NPE)
until it finds one which hosts your pico.
which
</p>
<p>
In Chrome and Firefox, you can register a handler for a "new" protocol.
</p>
<h2>Register a protocol handler</h2>
<p>
From any page served by your NPE,
enter the JavaScript console.
Evaluate this code, replacing <code id="npe">localhost:8080</code>
with the domain name and port of your NPE.
</p>
<pre><a id="rph" href='javascript:navigator.registerProtocolHandler("web+did","http://localhost:8080/did.html?url=%s","DID poc");void 0'>navigator.registerProtocolHandler("web+did","http://localhost:8080/did.html?url=%s","DID poc")</a></pre>
<p>
Your browser will warn you that your NPE wants to 
handle the "web+did" protocol,
which you must allow.
</p>
<h2>Using your protocol handler</h2>
<p>
Having done this you will be able to send an event or query to a pico
using the pseudo DID protocol as shown below.
Note that, for picos, the event channel identifier (ECI)
<em>is</em> a DID.
</p>
<pre>web+did:npe:&lt;ECI>/sky/event/&lt;EID>/domain/type?name=val&name2=val2</pre>
<pre>web+did:npe:&lt;ECI>/sky/cloud/&lt;RID>/function?name=val&name2=val2</pre>
<h2>Removing your protocol handler</h2>
<p>
To remove the protocol handler from Chrome, visit 
chrome://settings/handlers.
From Firefox, visit Preferences->Applications.
</p>
<h2>List of NPE which this redirector will try</h2>
</body>
<ul id="servers"></ul>
</html>

