<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>DID redirection</title>
<script src="js/jquery-3.1.0.min.js" type="text/javascript"></script>
<script src="js/did-simulator-eci.js" type="text/javascript"></script>
<script type="text/javascript">
$(function(){
  var this_npe = location.hostname+(location.port ? ":"+location.port : "");
  var did_sim_eci = window.did_simulator_eci;
  if(!did_sim_eci) {
    did_sim_eci = prompt("Enter an ECI for the Root Pico at "+this_npe);
  }
  var servers = [];
  var base_url = "/sky/cloud/"+did_sim_eci+"/io.picolabs.did_simulation";
  var url = base_url + "/servers";
  $.getJSON(url,function(data){
    if(data && data.length > 0) {
      for(var i=0; i<data.length; ++i) {
        servers.push(data[i]);
      }
    } else {
      $("body").html("Couldn't get a list of NPE to try");
      $("body").show();
    }
    if(location.search.startsWith("?url=")){
      var decoded = decodeURIComponent(location.search);
      if(decoded.startsWith("?url=web+did:npe:")){
        var pieces = decoded.substr(17).split("/");
        if(pieces.length >= 5){
          var did = pieces.shift();
          var stuff = pieces.shift() + "/" + pieces.shift() + "/"
                    + did + "/" + pieces.join("/");
          url = base_url + "/serverForDID?did=" + did;
          $.getJSON(url,function(server){
            if(server){
              var prefix = "http://" + server + "/";
              location = prefix+stuff;
            } else {
              $("body").html("Couldn't find <code>did:"+did+"</code>, having checked<ul><li>"+servers.join("</li><li>")+"</li></ul>");
              $("body").show();
            }
          });
        } else {
          $("body").show();
        }
      } else {
        $("body").show();
      }
    } else {
      $("body").show();
    }
    $("#npe").text(this_npe);
    var rph = 'navigator.registerProtocolHandler("web+did","http://'
            + this_npe
            + '/did.html?url=%s","DID poc")';
    $("#rph").attr("href",'javascript:'+rph+';void 0');
    $("#rph").text(rph);
    $("#servers").html("<li>"+servers.join("</li><li>")+"</li>");
  }).fail(function(obj) { alert("error"); alert(JSON.stringify(obj)); });
});
</script>
<style type="text/css">
pre { margin-left:20px; }
body { display:none; }
div { padding:10px; float:right; border:1px solid silver; }
div form { padding-left:40px; }
</style>
</head>
<body>
<h1>DID redirection</h1>
<div>
<h2>List of NPE which this redirector will try</h2>
<ul id="servers"></ul>
<form method="POST" onsubmit="alert('not yet implemented');return false">
<input type="text" name="server" placeholder="npe host:port">
<button type="submit">add</button>
</form>
</div>
<p>
This is a proof of concept, through simulation.
Soon, browsers will understand the <code>did</code> scheme directly.
They will use the DID to find the DDO on Sovrin and the DDO
will provide a list of endpoints for your browser to try.
Until then, we can use this simulator,
which will try a series of Node Pico Engines (NPE)
until it finds one which hosts your pico.
</p>
<h2>Register a protocol handler</h2>
<p>
In Chrome and Firefox, you can register a handler for a "new" protocol.
Click on the link below to register this page
as a handler for <code>web+did</code>.
</p>
<pre><a id="rph" href='javascript:navigator.registerProtocolHandler("web+did","http://localhost:8080/did.html?url=%s","DID poc");void 0'>navigator.registerProtocolHandler("web+did","http://localhost:8080/did.html?url=%s","DID poc")</a></pre>
<p>
Your browser will warn you that your NPE wants to 
handle the "web+did" protocol, which you must allow.
</p>
<p>
The Root Pico on this NPE must have the ruleset
<code>io.picolabs.did_simulation</code>.
You must provide an ECI for the Root Pico.
This ruleset contains the list of NPE to try
along with the code to determine which one
hosts the pico which reacts to the given ECI.
Note that, for picos, the event channel identifier (ECI)
<em>is</em> a DID.
</p>
<h2>Using your protocol handler</h2>
<p>
Having done this you will be able to send an event or query to a pico
using the pseudo DID protocol as shown below.
</p>
<pre>web+did:npe:&lt;ECI>/sky/event/&lt;EID>/domain/type?name=val&name2=val2</pre>
<pre>web+did:npe:&lt;ECI>/sky/cloud/&lt;RID>/function?name=val&name2=val2</pre>
<h2>Removing your protocol handler</h2>
<p>
To remove the protocol handler from Chrome, visit 
chrome://settings/handlers.
From Firefox, visit Preferences->Applications.
</p>
</body>
</html>

